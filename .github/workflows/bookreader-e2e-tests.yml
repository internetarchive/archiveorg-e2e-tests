name: BR E2E Tests

on: workflow_call

jobs:

  copy-br-files:
    runs-on: ubuntu-latest
    name: "Port tests over"

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: 'npm'
      - name: Cache BookReader test files
        uses: actions/cache@v2
        id: br-files-cache
        with:
          path: 'br-e2e-tests'
          key: ${{ runner.os }}-node-16-${{ hashFiles('package*.json') }}
      - if: steps.br-files-cache.outputs.cache-hit != 'true'
        run: npm run port-br-files
      - uses: actions/upload-artifact@master
        with:
          name: br-e2e-tests
          path: ${{ github.workspace }}/br-e2e-tests
  
  br-tests:
    runs-on: ubuntu-latest
    name: "E2E Tests => archive.org"
    needs: copy-br-files

    steps:
      - uses: actions/checkout@v2
      # - uses: actions/setup-node@v2
      #   with:
      #     node-version: '16.x'
      #     cache: 'npm'
      # - run: npm global add testcafe
      # - uses: actions/setup-node@v2
      #   with:
      #     node-version: '16.x'
      #     cache: 'npm'
      # - run: npm run run-br-tests
      - uses: actions/download-artifact@master
        with:
          name: br-e2e-tests
          path: br-e2e-tests/
      - uses: DevExpress/testcafe-action@latest
        with:
          skip-install: true
          args: "chrome, firefox, --color --quarantine path: ${{ github.workspace }}/br-e2e-tests/br-e2e-tests/ia-production/ia-prod-base.js"